<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento com Cartão - Mercado Pago</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .payment-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .header h1 {
            color: #009ee3;
            font-weight: 700;
        }
        .product-summary {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-control:focus {
            border-color: #009ee3;
            box-shadow: 0 0 0 0.2rem rgba(0, 158, 227, 0.25);
        }
        .card-icon {
            font-size: 24px;
            color: #666;
            margin-right: 10px;
        }
        .btn-primary {
            background-color: #009ee3;
            border-color: #009ee3;
            padding: 12px;
            font-weight: 600;
        }
        .btn-primary:hover {
            background-color: #0080b9;
            border-color: #0080b9;
        }
        .secure-payment {
            text-align: center;
            margin-top: 1rem;
            color: #6c757d;
        }
        .loading {
            display: none;
            text-align: center;
            margin-top: 1rem;
        }
        .success-message {
            display: none;
            text-align: center;
            color: #28a745;
            margin-top: 1rem;
        }
        .error-message {
            display: none;
            text-align: center;
            color: #dc3545;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="payment-container">
            <div class="header">
                <h1><i class="fab fa-mercadopago"></i> Pagamento com Cartão</h1>
                <p class="text-muted">Finalize sua compra de forma segura com Mercado Pago</p>
            </div>

            <div class="product-summary">
                <h5>Resumo da Compra</h5>
                <div id="product-details">
                    <!-- Os detalhes do produto serão preenchidos via JavaScript -->
                </div>
            </div>

            <form id="payment-form">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="cardNumber">Número do Cartão</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-credit-card card-icon"></i></span>
                                <input type="text" class="form-control" id="cardNumber" placeholder="0000 0000 0000 0000" required>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="cardholderName">Nome no Cartão</label>
                            <input type="text" class="form-control" id="cardholderName" placeholder="Como está no cartão" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="expirationDate">Data de Validade</label>
                            <input type="text" class="form-control" id="expirationDate" placeholder="MM/AA" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="securityCode">Código de Segurança</label>
                            <input type="text" class="form-control" id="securityCode" placeholder="000" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="installments">Parcelas</label>
                            <select class="form-control" id="installments" required>
                                <option value="">Selecionar...</option>
                                <!-- As opções de parcelamento serão preenchidas via JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="identificationType">Tipo de Documento</label>
                    <select class="form-control" id="identificationType" required>
                        <option value="">Selecionar...</option>
                        <option value="CPF">CPF</option>
                        <option value="CNPJ">CNPJ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="identificationNumber">Número do Documento</label>
                    <input type="text" class="form-control" id="identificationNumber" placeholder="000.000.000-00" required>
                </div>

                <button type="submit" class="btn btn-primary btn-lg btn-block w-100">
                    <i class="fas fa-lock"></i> Pagar Agora
                </button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Processando...</span>
                </div>
                <p class="mt-2">Processando seu pagamento...</p>
            </div>

            <div class="success-message" id="success-message">
                <i class="fas fa-check-circle fa-3x"></i>
                <h4 class="mt-3">Pagamento Aprovado!</h4>
                <p>Seu pagamento foi processado com sucesso.</p>
                <p id="payment-details"></p>
                <a href="/" class="btn btn-success mt-3">Voltar à Loja</a>
            </div>

            <div class="error-message" id="error-message">
                <i class="fas fa-exclamation-circle fa-3x"></i>
                <h4 class="mt-3">Erro no Pagamento</h4>
                <p id="error-details">Ocorreu um problema ao processar seu pagamento.</p>
                <button class="btn btn-secondary mt-3" onclick="window.location.reload()">Tentar Novamente</button>
            </div>

            <div class="secure-payment">
                <p><i class="fas fa-lock"></i> Pagamento 100% seguro via Mercado Pago</p>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Mercado Pago
        const mp = new MercadoPago('APP_USR-36ed559d-8b4a-4e5c-abb1-9d191a7e4ab1', {
            locale: 'pt-BR'
        });

        // Dados da compra
        let compra = JSON.parse(localStorage.getItem('compraAtual')) || {};
        let paymentMethodId = null;
        let issuerId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Exibir detalhes do produto
            displayProductDetails();
            
            // Buscar métodos de pagamento e informações de parcelamento
            loadPaymentMethods();
            
            // Configurar máscaras para os campos
            setupInputMasks();
            
            // Configurar evento de submit do formulário
            document.getElementById('payment-form').addEventListener('submit', processPayment);
        });

        function displayProductDetails() {
            const productDetails = document.getElementById('product-details');
            if (compra.itens && compra.itens.length > 0) {
                let html = '';
                compra.itens.forEach(item => {
                    html += `<p>${item.nome} - R$ ${item.preco.toFixed(2)} x ${item.quantidade}</p>`;
                });
                const total = compra.itens.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
                html += `<hr><h5>Total: R$ ${total.toFixed(2)}</h5>`;
                productDetails.innerHTML = html;
            } else {
                productDetails.innerHTML = '<p>Nenhum produto encontrado</p>';
            }
        }

        function setupInputMasks() {
            // Máscara para número do cartão
            const cardNumber = document.getElementById('cardNumber');
            cardNumber.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/(\d{4})/g, '$1 ').trim();
                e.target.value = value.substring(0, 19);
            });

            // Máscara para data de validade
            const expirationDate = document.getElementById('expirationDate');
            expirationDate.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value.substring(0, 5);
            });

            // Máscara para código de segurança
            const securityCode = document.getElementById('securityCode');
            securityCode.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4);
            });

            // Máscara para CPF/CNPJ
            const identificationNumber = document.getElementById('identificationNumber');
            identificationNumber.addEventListener('input', function(e) {
                const type = document.getElementById('identificationType').value;
                let value = e.target.value.replace(/\D/g, '');
                
                if (type === 'CPF') {
                    if (value.length > 11) value = value.substring(0, 11);
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                } else if (type === 'CNPJ') {
                    if (value.length > 14) value = value.substring(0, 14);
                    value = value.replace(/(\d{2})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1/$2');
                    value = value.replace(/(\d{4})(\d)/, '$1-$2');
                }
                
                e.target.value = value;
            });
        }

        async function loadPaymentMethods() {
            try {
                // Obter métodos de pagamento disponíveis
                const paymentMethods = await mp.getPaymentMethods();
                
                // Filtrar apenas cartões de crédito
                const creditCardMethods = paymentMethods.filter(method => 
                    method.payment_type_id === 'credit_card'
                );
                
                // Aqui você pode usar essas informações para customizar a UI
                console.log('Métodos de pagamento:', creditCardMethods);
                
                // Carregar opções de parcelamento
                await loadInstallments();
            } catch (error) {
                console.error('Erro ao carregar métodos de pagamento:', error);
            }
        }

        async function loadInstallments() {
            try {
                const total = compra.itens.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
                
                // Obter opções de parcelamento
                const installments = await mp.getInstallments({
                    amount: total,
                    paymentMethodId: 'credit_card' // Você pode ajustar conforme o método selecionado
                });
                
                const installmentsSelect = document.getElementById('installments');
                installmentsSelect.innerHTML = '<option value="">Selecionar...</option>';
                
                if (installments[0] && installments[0].payer_costs) {
                    installments[0].payer_costs.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.installments;
                        optionElement.textContent = `${option.installments}x de R$ ${option.installment_amount.toFixed(2)} - Total: R$ ${option.total_amount.toFixed(2)}`;
                        installmentsSelect.appendChild(optionElement);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar parcelamentos:', error);
            }
        }

        async function processPayment(event) {
            event.preventDefault();
            
            // Validar formulário
            if (!validateForm()) {
                return;
            }
            
            // Mostrar loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('payment-form').style.display = 'none';
            
            try {
                // Obter token do cartão
                const cardToken = await createCardToken();
                
                // Criar pagamento
                const paymentResult = await createPayment(cardToken);
                
                // Verificar resultado
                if (paymentResult.status === 'approved') {
                    showSuccess(paymentResult);
                } else {
                    showError('Pagamento não aprovado: ' + paymentResult.status_detail);
                }
            } catch (error) {
                console.error('Erro no processamento do pagamento:', error);
                showError(error.message || 'Erro ao processar pagamento');
            }
        }

        function validateForm() {
            // Validações básicas
            const inputs = document.querySelectorAll('#payment-form input, #payment-form select');
            let isValid = true;
            
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            
            return isValid;
        }

        async function createCardToken() {
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const expirationDate = document.getElementById('expirationDate').value.split('/');
            const securityCode = document.getElementById('securityCode').value;
            const cardholderName = document.getElementById('cardholderName').value;
            
            // Criar token do cartão
            const token = await mp.createCardToken({
                cardNumber: cardNumber,
                expirationMonth: expirationDate[0],
                expirationYear: '20' + expirationDate[1],
                securityCode: securityCode,
                cardholderName: cardholderName
            });
            
            return token.id;
        }

        async function createPayment(cardToken) {
            const total = compra.itens.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            const installments = document.getElementById('installments').value;
            const identificationType = document.getElementById('identificationType').value;
            const identificationNumber = document.getElementById('identificationNumber').value.replace(/\D/g, '');
            
            // Dados para a API de pagamentos do Mercado Pago
            const paymentData = {
                transaction_amount: total,
                token: cardToken,
                description: 'Compra na Loja Tecnologia DS',
                installments: parseInt(installments),
                payment_method_id: 'credit_card',
                payer: {
                    email: 'comprador@email.com', // Você deve obter este email do seu sistema
                    identification: {
                        type: identificationType,
                        number: identificationNumber
                    }
                }
            };
            
            // Fazer a requisição para a API do Mercado Pago
            const response = await fetch('https://api.mercadopago.com/v1/payments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer APP_USR-1234567890123456-123456-abcdefghijklmnopqrstuvwxyz123456' // Seu access token
                },
                body: JSON.stringify(paymentData)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Erro ao processar pagamento');
            }
            
            return await response.json();
        }

        function showSuccess(paymentResult) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('success-message').style.display = 'block';
            
            const paymentDetails = document.getElementById('payment-details');
            paymentDetails.innerHTML = `
                <p>ID do Pagamento: ${paymentResult.id}</p>
                <p>Status: ${paymentResult.status}</p>
                <p>Valor: R$ ${paymentResult.transaction_amount.toFixed(2)}</p>
            `;
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-details').textContent = message;
            document.getElementById('payment-form').style.display = 'block';
        }
    </script>
</body>
</html>